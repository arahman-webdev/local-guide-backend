generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

// -------------------------
// Users & Roles
// 

model User {
  id       String   @id @default(cuid())
  name     String
  email    String   @unique
  phone    String?
  address  String?
  password String?
  role     UserRole @default(TOURIST)

  profilePic String?
  profileId  String?
  bio        String?
  languages  String[] // ["English", "Bangla"]

  // Tourist Fields
  travelPrefs String?

  // Guide Fields
  expertise String?
  dailyRate Float?

  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  tours    Tour[]
  bookings Booking[]
  reviews  Review[]
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  DELETED
}

enum UserRole {
  TOURIST
  GUIDE
  ADMIN
}

// -------------------------
// Tour Listings
// -------------------------
model Tour {
  id           String @id @default(cuid())
  title        String
  slug         String @unique
  description  String
  itinerary    String
  fee          Float
  duration     String // in hours
  meetingPoint String

  // Group size
  maxGroupSize Int
  minGroupSize Int @default(1)

  category TourCategory

  city    String
  country String

  currency String   @default("USD")
  tags     String[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings      Booking[]
  reviews       Review[]
  user          User           @relation(fields: [userId], references: [id])
  userId        String
  tourImages    TourImages[]
  tourLanguages TourLanguage[]
}

enum TourCategory {
  FOOD
  ART
  ADVENTURE
  HISTORY
  NIGHTLIFE
  NATURE
  WILDLIFE
  SHOPPING
  HERITAGE
  OTHER
}

model TourLanguage {
  id     String @id @default(cuid())
  name   String
  tour   Tour   @relation(fields: [tourId], references: [id])
  tourId String
}

// -------------------------
// TourImages
// -------------------------

model TourImages {
  id        String   @id @default(cuid())
  imageUrl  String?
  imageId   String?
  tourId    String
  tour      Tour     @relation(fields: [tourId], references: [id])
  createdAt DateTime @default(now())
}

// -------------------------
// Bookings
// -------------------------
model Booking {
  id          String  @id @default(cuid())
  bookingCode String? @unique
  tour        Tour    @relation(fields: [tourId], references: [id])
  tourId      String

  status    BookingStatus @default(PENDING)
  startTime DateTime
  endTime   DateTime

  payment Payment?

  // Change from reviews[] (plural) to review (singular)
  review   Review?  // One booking can have one review

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  user                  User                   @relation(fields: [userId], references: [id])
  userId                String
  sslcommerzTransaction SSLCommerzTransaction?
  
  // Add indexes for better queries
  @@index([userId])
  @@index([status])
  @@index([startTime])
}
enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// -------------------------
// Payments
// -------------------------
model Payment {
  id        String   @id @default(cuid())
  booking   Booking? @relation(fields: [bookingId], references: [id])
  bookingId String?  @unique

  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String? // from Stripe/other gateway

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentMethod {
  STRIPE
  SSL_COMMERZ
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model SSLCommerzTransaction {
  id              String   @id @default(cuid())
  transactionId   String   @unique // Your generated tran_id
  bookingId       String?  @unique
  booking         Booking? @relation(fields: [bookingId], references: [id])
  sessionKey      String? // From SSLCommerz response
  gatewayUrl      String? // Payment gateway URL
  valId           String? // Validation ID from SSLCommerz
  amount          Float
  currency        String   @default("BDT")
  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELLED
  bankTransaction String? // Bank transaction ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------
// Reviews
// -------------------------
model Review {
  id         String  @id @default(cuid())
  reviewCode String? @unique
  tour       Tour    @relation(fields: [tourId], references: [id])
  tourId     String

  booking   Booking? @relation(fields: [bookingId], references: [id])
  bookingId String?  @unique // Make it unique to prevent one booking having multiple reviews

  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String
  
  // Add indexes for better performance
  @@index([userId])
  @@index([tourId])
  @@unique([userId, tourId]) // Prevent user reviewing same tour multiple times
}